<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Asistente de actuaci√≥n ‚Äì Muerte fetal</title>

<style>
:root{
  --brand-green:#508070;
  --bg:#f6f7f9;
  --card:#ffffff;
  --text:#111;
  --muted:#555;
  --border:#d0d7de;
  --warning-bg:#fff4cc;
  --warning-border:#e0b800;
  font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text)}

header{
  position:sticky;top:0;z-index:10;
  background:var(--brand-green);color:#fff;
  padding:14px;
  text-align:center;
}
header .hospital{font-weight:800}
header .service{font-size:13px;line-height:1.2;margin-top:4px}
header .appname{font-size:14px;font-weight:800;margin-top:6px}

main{padding:14px;max-width:900px;margin:0 auto;padding-bottom:40px}

.card{
  background:var(--card);
  border-radius:16px;
  padding:14px;
  box-shadow:0 2px 10px rgba(0,0,0,.06);
  margin-bottom:12px;
}

label{font-weight:800;font-size:14px;display:block}

#weeks{
  width:100%;
  padding:14px;
  border-radius:12px;
  border:1px solid var(--border);
  font-size:18px;
  font-weight:800;
  margin-top:6px;
  line-height:1.2;
}

.seg{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
.seg button{
  flex:1;
  min-width:130px;
  padding:14px;
  border-radius:12px;
  border:1px solid var(--border);
  background:#fff;
  font-size:18px;
  font-weight:800;
  cursor:pointer;
  transition:all .12s ease;
}
.seg button.active{
  background:var(--brand-green);
  color:#fff;
  border-color:var(--brand-green);
  box-shadow:0 4px 10px rgba(0,0,0,.12);
}
.seg button:disabled{
  opacity:.40;
  cursor:not-allowed;
  box-shadow:none;
}

.btn{
  width:100%;
  padding:20px;
  border-radius:18px;
  border:0;
  background:#005bbb;
  color:#fff;
  font-size:20px;
  font-weight:900;
  margin-top:18px;
  box-shadow:0 10px 22px rgba(0,0,0,.28);
}
.btn:disabled{
  background:#9aa3ad;
  box-shadow:none;
}

.warning{
  background:var(--warning-bg);
  border-left:5px solid var(--warning-border);
  padding:10px;
  border-radius:10px;
  margin-top:8px;
  font-size:14px;
  line-height:1.25;
}

.obs-card{
  background:#eaf6f1;
  border-left:5px solid var(--brand-green);
}
.obs-title{display:flex;gap:8px;align-items:center}
.obs-icon{font-size:18px}

.control-info{font-size:12px;color:#777}

h2{margin:0 0 8px;font-size:16px}
ul{margin:0;padding-left:18px}
li{margin:6px 0}
.grid2{display:grid;grid-template-columns:1fr;gap:12px}
@media (min-width:820px){.grid2{grid-template-columns:1fr 1fr}}
</style>
</head>

<body>
<header>
  <div class="hospital">Hospital Universitario Virgen de las Nieves</div>
  <div class="service">
    Servicio de Obstetricia y Ginecolog√≠a<br>
    y Servicio de Anatom√≠a Patol√≥gica
  </div>
  <div class="appname">Asistente de actuaci√≥n ‚Äì Muerte fetal</div>
</header>

<main>
  <div id="topcard" class="card">
    <label for="weeks">Edad gestacional (semanas)</label>
    <input id="weeks"
      type="text"
      inputmode="numeric"
      autocomplete="off"
      autocapitalize="off"
      spellcheck="false"
      maxlength="2"
      placeholder="Ej.: 20"
    >
    <div id="weeks_hint" style="font-size:13px;margin-top:6px;color:#555">
      Valores permitidos de 10 a 42.
    </div>

    <div id="nv_block" style="margin-top:14px;display:none">
      <label>¬øNaci√≥ vivo?</label>
      <div class="seg" role="group" aria-label="Nace vivo">
        <button id="nv_no" type="button">No</button>
        <button id="nv_si" type="button">S√≠</button>
      </div>
    </div>

    <div id="ret_block" style="margin-top:14px;display:none">
      <label>¬øDesean retirar los restos?</label>
      <div class="seg" role="group" aria-label="Retiran restos">
        <button id="ret_no" type="button">No</button>
        <button id="ret_si" type="button">S√≠</button>
      </div>
      <div id="ret_note" class="warning" style="display:none"></div>
    </div>

    <div id="ap_block" style="margin-top:14px;display:none">
      <label>¬øDesean necropsia (estudio de Anatom√≠a Patol√≥gica)?</label>
      <div id="ap_note" class="warning" style="display:none"></div>
      <div class="seg" role="group" aria-label="Desean necropsia">
        <button id="ap_no" type="button">No</button>
        <button id="ap_si" type="button">S√≠</button>
      </div>
    </div>

    <button id="go" class="btn" type="button" disabled>üìã Mostrar qu√© hay que hacer</button>
  </div>

  <div id="out"></div>
</main>

<script>
/* ====== SCENARIOS ======
   (Sin escenarios naceVivo=true + retirada=false: eliminados)
*/
var SCENARIOS = [
  // <14
  { id:"S01", group:"LT14", naceVivo:null, retirada:false, necropsia:true,
    observaciones:"La norma general es que los padres no retiren los restos dada la edad gestacional",
    documentos:["Petici√≥n Anatom√≠a Patol√≥gica (√∫nica)"],
    envio:["Feto y placenta juntos en formol"],
    eliminacion:["Seg√∫n protocolo interno de Anatom√≠a Patol√≥gica"]
  },
  { id:"S02", group:"LT14", naceVivo:null, retirada:false, necropsia:false,
    observaciones:"La norma general es que los padres no retiren los restos dada la edad gestacional",
    documentos:["Petici√≥n Anatom√≠a Patol√≥gica (√∫nica) especificando que no desean necropsia"],
    envio:["Feto y placenta juntos en formol"],
    eliminacion:["Seg√∫n protocolo interno de Anatom√≠a Patol√≥gica"]
  },
  { id:"S03", group:"LT14", naceVivo:null, retirada:true, necropsia:null,
    observaciones:"Situaci√≥n excepcional. Si retiran los restos no es posible el estudio anatomopatol√≥gico",
    documentos:[
      "Autorizaci√≥n/rechazo de necropsia y/o tratamiento de restos fetales",
      "Declaraci√≥n y parte de alumbramiento de criaturas abortivas (hoja rosa)"
    ],
    envio:["Bote vac√≠o en fresco","Entrega a la funeraria"],
    eliminacion:["Funeraria a cargo de los padres"]
  },

  // 14-21
  { id:"S04", group:"14_21", naceVivo:false, retirada:false, necropsia:true, observaciones:"",
    documentos:["Petici√≥n Anatom√≠a Patol√≥gica (doble)","Autorizaci√≥n/rechazo de necropsia y/o tratamiento de restos fetales"],
    envio:["Feto y placenta por separado:","- Feto: seco y fr√≠o si se env√≠a < 72 h, si no en formol.","- Placenta en formol"],
    eliminacion:["Seg√∫n protocolo interno de Anatom√≠a Patol√≥gica"]
  },
  { id:"S10", group:"14_21", naceVivo:false, retirada:false, necropsia:false, observaciones:"",
    documentos:["Petici√≥n Anatom√≠a Patol√≥gica (placenta).","Autorizaci√≥n/rechazo de necropsia y/o tratamiento de restos fetales (rechazando necropsia)","Declaraci√≥n y parte de alumbramiento de criaturas abortivas (hoja rosa)","Bolet√≠n estad√≠stico"],
    envio:["Feto y placenta por separado:","- Feto: seco y fr√≠o si se env√≠a < 72 h, si no en formol.","- Placenta en formol"],
    eliminacion:["Seg√∫n protocolo interno de Anatom√≠a Patol√≥gica"]
  },
  { id:"S06", group:"14_21", naceVivo:true, retirada:true, necropsia:true, observaciones:"",
    documentos:["Petici√≥n Anatom√≠a Patol√≥gica (doble).","Autorizaci√≥n/rechazo de necropsia y/o tratamiento de restos fetales (rellenando apartado de certificado de muerte cierta)","Certificado de nacimiento","Certificado de defunci√≥n","Declaraci√≥n y parte de alumbramiento de criaturas abortivas (hoja rosa)","Bolet√≠n estad√≠stico"],
    envio:["Feto y placenta por separado:","- Feto: seco y fr√≠o si se env√≠a < 72 h, si no en formol.","- Placenta en formol"],
    eliminacion:["Funeraria a cargo de los padres: Retirar los restos en Anatom√≠a Patol√≥gica antes de 30 d√≠as"]
  },
  { id:"S07", group:"14_21", naceVivo:true, retirada:true, necropsia:false, observaciones:"",
    documentos:["Petici√≥n Anatom√≠a Patol√≥gica (placenta). Especificando que no desean necropsia","Autorizaci√≥n/rechazo de necropsia y/o tratamiento de restos fetales (rellenando apartado de certificado de muerte cierta)","Certificado de nacimiento","Certificado de defunci√≥n","Declaraci√≥n y parte de alumbramiento de criaturas abortivas (hoja rosa)","Bolet√≠n estad√≠stico"],
    envio:["Feto y placenta por separado:","- Feto: seco y fr√≠o si se env√≠a < 72 h, si no en formol.","- Placenta en formol"],
    eliminacion:["Feto a la c√°mara mortuoria. Funeraria a cargo de los padres: Retirar los restos de la c√°mara mortuoria","Placenta a Anatom√≠a Patol√≥gica"]
  },
  { id:"S08", group:"14_21", naceVivo:false, retirada:true, necropsia:false, observaciones:"",
    documentos:["Petici√≥n Anatom√≠a Patol√≥gica (placenta). Especificando que no desean necropsia","Autorizaci√≥n/rechazo de necropsia y/o tratamiento de restos fetales","Declaraci√≥n y parte de alumbramiento de criaturas abortivas (hoja rosa)","Bolet√≠n estad√≠stico"],
    envio:["Feto y placenta por separado:","- Feto: en seco y fr√≠o.","- Placenta en formol"],
    eliminacion:["Feto a la c√°mara mortuoria. Funeraria a cargo de los padres: Retirar los restos de la c√°mara mortuoria","Placenta a Anatom√≠a Patol√≥gica"]
  },
  { id:"S09", group:"14_21", naceVivo:false, retirada:true, necropsia:true, observaciones:"",
    documentos:["Petici√≥n Anatom√≠a Patol√≥gica (doble).","Autorizaci√≥n/rechazo de necropsia y/o tratamiento de restos fetales","Declaraci√≥n y parte de alumbramiento de criaturas abortivas (hoja rosa)","Bolet√≠n estad√≠stico"],
    envio:["Feto y placenta por separado:","- Feto: seco y fr√≠o si se env√≠a < 72 h, si no en formol.","- Placenta en formol"],
    eliminacion:["Funeraria: Retirar los restos en Anatom√≠a Patol√≥gica antes de 30 d√≠as"]
  },

  // 22-25
  { id:"S11", group:"22_25", naceVivo:false, retirada:false, necropsia:true, observaciones:"",
    documentos:["Petici√≥n Anatom√≠a Patol√≥gica (doble).","Autorizaci√≥n/rechazo de necropsia y/o tratamiento de restos fetales (autorizando necropsia)","Declaraci√≥n y parte de alumbramiento de criaturas abortivas (hoja rosa)","Bolet√≠n estad√≠stico"],
    envio:["Feto y placenta por separado:","- Feto: seco y fr√≠o si se env√≠a < 72 h, si no en formol.","- Placenta en formol"],
    eliminacion:["Seg√∫n protocolo interno de Anatom√≠a Patol√≥gica"]
  },
  { id:"S12", group:"22_25", naceVivo:false, retirada:false, necropsia:false, observaciones:"",
    documentos:["Petici√≥n Anatom√≠a Patol√≥gica (placenta).","Autorizaci√≥n/rechazo de necropsia y/o tratamiento de restos fetales (rechazando necropsia)","Declaraci√≥n y parte de alumbramiento de criaturas abortivas (hoja rosa)","Bolet√≠n estad√≠stico"],
    envio:["Feto y placenta por separado:","- Feto: seco y fr√≠o si se env√≠a < 72 h, si no en formol.","- Placenta en formol"],
    eliminacion:["Seg√∫n protocolo interno de Anatom√≠a Patol√≥gica"]
  },
  { id:"S13", group:"22_25", naceVivo:true, retirada:true, necropsia:true,
    observaciones:"Si nace vivo, la retirada de los restos por parte de los padres es obligatoria",
    documentos:["Petici√≥n Anatom√≠a Patol√≥gica (doble)","Autorizaci√≥n/rechazo de necropsia y/o tratamiento de restos fetales (rechazando necropsia)","Declaraci√≥n y parte de alumbramiento de criaturas abortivas (hoja rosa)","Certificado de nacimiento","Certificado de defunci√≥n","Bolet√≠n estad√≠stico"],
    envio:["Feto y placenta por separado:","- Feto: seco y fr√≠o si se env√≠a < 72 h, si no en formol.","- Placenta en formol"],
    eliminacion:["Funeraria a cargo de los padres: Retirar los restos en Anatom√≠a Patol√≥gica antes de 30 d√≠as"]
  },
  { id:"S14", group:"22_25", naceVivo:true, retirada:true, necropsia:false,
    observaciones:"Si nace vivo, la retirada de los restos por parte de los padres es obligatoria",
    documentos:["Petici√≥n Anatom√≠a Patol√≥gica (placenta)","Autorizaci√≥n/rechazo de necropsia y/o tratamiento de restos fetales (rechazando necropsia)","Declaraci√≥n y parte de alumbramiento de criaturas abortivas (hoja rosa)","Certificado de nacimiento","Certificado de defunci√≥n","Bolet√≠n estad√≠stico"],
    envio:["Feto y placenta por separado:","- Feto: en seco y fr√≠o","- Placenta en formol"],
    eliminacion:["Feto a la c√°mara mortuoria: Funeraria a cargo de los padres","Placenta a Anatom√≠a Patol√≥gica"]
  },
  { id:"S15", group:"22_25", naceVivo:false, retirada:true, necropsia:true, observaciones:"",
    documentos:["Petici√≥n Anatom√≠a Patol√≥gica (doble)","Autorizaci√≥n/rechazo de necropsia y/o tratamiento de restos fetales","Declaraci√≥n y parte de alumbramiento de criaturas abortivas (hoja rosa)","Bolet√≠n estad√≠stico"],
    envio:["Feto y placenta por separado:","- Feto: seco y fr√≠o si se env√≠a < 72 h, si no en formol.","- Placenta en formol"],
    eliminacion:["Funeraria: Retirar los restos en Anatom√≠a Patol√≥gica antes de 30 d√≠as"]
  },
  { id:"S16", group:"22_25", naceVivo:false, retirada:true, necropsia:false, observaciones:"",
    documentos:["Petici√≥n Anatom√≠a Patol√≥gica (placenta), especificando que no desean necropsia","Declaraci√≥n y parte de alumbramiento de criaturas abortivas (hoja rosa)","Bolet√≠n estad√≠stico"],
    envio:["Feto y placenta por separado:","- Feto: en seco y fr√≠o","- Placenta en formol"],
    eliminacion:["Feto a la c√°mara mortuoria: Funeraria a cargo de los padres","Placenta a Anatom√≠a Patol√≥gica"]
  },

  // ‚â•26
  { id:"S17", group:"GE26", naceVivo:false, retirada:true, necropsia:false, observaciones:"",
    documentos:["Petici√≥n Anatom√≠a Patol√≥gica (placenta). Especificando que no desean necropsia","Autorizaci√≥n/rechazo de necropsia y/o tratamiento de restos fetales","Declaraci√≥n y parte de alumbramiento de criaturas abortivas (hoja rosa)","Bolet√≠n estad√≠stico"],
    envio:["Feto y placenta por separado:","- Feto: en seco y fr√≠o","- Placenta en formol"],
    eliminacion:["Feto a la c√°mara mortuoria: Funeraria a cargo de los padres","Placenta a Anatom√≠a Patol√≥gica"]
  },
  { id:"S23", group:"GE26", naceVivo:false, retirada:true, necropsia:true, observaciones:"",
    documentos:["Petici√≥n Anatom√≠a Patol√≥gica (doble)","Autorizaci√≥n/rechazo de necropsia y/o tratamiento de restos fetales","Declaraci√≥n y parte de alumbramiento de criaturas abortivas (hoja rosa)","Bolet√≠n estad√≠stico"],
    envio:["Feto y placenta por separado:","- Feto: en seco y fr√≠o","- Placenta en formol"],
    eliminacion:["Funeraria: Retirar los restos en Anatom√≠a Patol√≥gica antes de 30 d√≠as"]
  },
  { id:"S18", group:"GE26", naceVivo:false, retirada:false, necropsia:true, observaciones:"",
    documentos:["Petici√≥n Anatom√≠a Patol√≥gica (doble).","Autorizaci√≥n/rechazo de necropsia y/o tratamiento de restos fetales","Declaraci√≥n y parte de alumbramiento de criaturas abortivas (hoja rosa)","Bolet√≠n estad√≠stico"],
    envio:["Feto y placenta por separado:","- Feto: seco y fr√≠o si se env√≠a < 72 h, si no en formol.","- Placenta en formol"],
    eliminacion:["Incineraci√≥n a cargo del Hospital"]
  },
  { id:"S19", group:"GE26", naceVivo:true, retirada:true, necropsia:false,
    observaciones:"Si nace vivo y no desean necropsia, la retirada de los restos por parte de los padres es obligatoria",
    documentos:["Petici√≥n Anatom√≠a Patol√≥gica (placenta). Especificando que no desean necropsia","Autorizaci√≥n/rechazo de necropsia y/o tratamiento de restos fetales (rechazando necropsia)","Declaraci√≥n y parte de alumbramiento de criaturas abortivas (hoja rosa)","Certificado de nacimiento","Certificado de defunci√≥n","Bolet√≠n estad√≠stico"],
    envio:["Feto y placenta por separado:","- Feto: en seco y fr√≠o","- Placenta en formol"],
    eliminacion:["Feto a la c√°mara mortuoria: Funeraria a cargo de los padres","Placenta a Anatom√≠a Patol√≥gica"]
  },
  { id:"S20", group:"GE26", naceVivo:true, retirada:true, necropsia:true, observaciones:"",
    documentos:["Petici√≥n Anatom√≠a Patol√≥gica (doble).","Autorizaci√≥n/rechazo de necropsia y/o tratamiento de restos fetales","Declaraci√≥n y parte de alumbramiento de criaturas abortivas (hoja rosa)","Certificado de nacimiento","Certificado de defunci√≥n","Bolet√≠n estad√≠stico"],
    envio:["Feto y placenta por separado:","- Feto: seco y fr√≠o si se env√≠a < 72 h, si no en formol.","- Placenta en formol"],
    eliminacion:["Funeraria a cargo de los padres: Retirar los restos en Anatom√≠a Patol√≥gica antes de 30 d√≠as"]
  }
];

/* ===== Helpers ===== */
function $(id){ return document.getElementById(id); }
function escapeHtml(s){
  return String(s)
    .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
}
function normalizeItem(s){ return String(s||"").replace(/\s+/g," ").replace(/^\s+|\s+$/g,""); }
function dedupe(items){
  if(!items||!items.length) return [];
  var seen={}, out=[];
  for(var i=0;i<items.length;i++){
    var t=normalizeItem(items[i]); if(!t) continue;
    if(seen[t]) continue; seen[t]=true; out.push(t);
  }
  return out;
}
function renderList(title, items){
  var clean=dedupe(items);
  var html='<div class="card"><h2>'+escapeHtml(title)+'</h2>';
  if(!clean.length){ html+='<div style="color:#777">‚Äî</div></div>'; return html; }
  html+='<ul>';
  for(var i=0;i<clean.length;i++) html+='<li>'+escapeHtml(clean[i])+'</li>';
  html+='</ul></div>';
  return html;
}
function computeGroup(weeks){
  if(typeof weeks!=="number"||!isFinite(weeks)) return null;
  if(weeks<14) return "LT14";
  if(weeks<=21) return "14_21";
  if(weeks<=25) return "22_25";
  return "GE26";
}
function groupLabel(g){
  if(g==="LT14") return "< 14 semanas";
  if(g==="14_21") return "14‚Äì21 semanas";
  if(g==="22_25") return "22‚Äì25 semanas";
  if(g==="GE26") return "‚â• 26 semanas";
  return "";
}
function setActive(btnId, groupIds){
  for(var i=0;i<groupIds.length;i++) $(groupIds[i]).classList.remove("active");
  $(btnId).classList.add("active");
}
function clearActive(groupIds){
  for(var i=0;i<groupIds.length;i++) $(groupIds[i]).classList.remove("active");
}
function setEnabled(btnId, enabled){
  $(btnId).disabled = !enabled;
  if(!enabled) $(btnId).classList.remove("active");
}

/* ===== Estado ===== */
var state={ weeks:null, group:null, naceVivo:null, retirada:null, necropsia:null };

/* Filtro escenarios */
function filterScenarios(partial){
  var arr=[];
  for(var i=0;i<SCENARIOS.length;i++){
    var sc=SCENARIOS[i];
    if(partial.group && sc.group!==partial.group) continue;
    if(partial.naceVivo!==null && partial.naceVivo!==undefined){
      if(sc.naceVivo!==null && sc.naceVivo!==partial.naceVivo) continue;
    }
    if(partial.retirada!==null && partial.retirada!==undefined){
      if(sc.retirada!==null && sc.retirada!==partial.retirada) continue;
    }
    if(partial.necropsia!==null && partial.necropsia!==undefined){
      if(sc.necropsia!==null && sc.necropsia!==partial.necropsia) continue;
    }
    arr.push(sc);
  }
  return arr;
}
function allNull(arr, field){
  if(!arr.length) return true;
  for(var i=0;i<arr.length;i++) if(arr[i][field]!==null) return false;
  return true;
}
function anyValue(arr, field, value){
  for(var i=0;i<arr.length;i++) if(arr[i][field]===value) return true;
  return false;
}

/* Reset */
function resetAfterWeeks(){
  state.naceVivo=null; state.retirada=null; state.necropsia=null;
  clearActive(["nv_no","nv_si","ret_no","ret_si","ap_no","ap_si"]);
  $("out").innerHTML="";
}
function resetAfterNV(){
  state.retirada=null; state.necropsia=null;
  clearActive(["ret_no","ret_si","ap_no","ap_si"]);
  $("out").innerHTML="";
}
function resetAfterRet(){
  state.necropsia=null;
  clearActive(["ap_no","ap_si"]);
  $("out").innerHTML="";
}
function resetAfterAP(){
  $("out").innerHTML="";
}

/* ===== UI principal ===== */
function updateUI(){
  // reset avisos
  $("ret_note").style.display="none";
  $("ret_note").textContent="";
  $("ap_note").style.display="none";
  $("ap_note").textContent="";

  // botones por defecto habilitados (luego reglas)
  setEnabled("nv_no", true); setEnabled("nv_si", true);
  setEnabled("ret_no", true); setEnabled("ret_si", true);
  setEnabled("ap_no", true); setEnabled("ap_si", true);

  if(!state.group){
    $("nv_block").style.display="none";
    $("ret_block").style.display="none";
    $("ap_block").style.display="none";
    $("go").disabled=true;
    return;
  }

  // Naci√≥ vivo aplica salvo <14
  var nvAll = filterScenarios({ group: state.group });
  var nvApplies = !allNull(nvAll, "naceVivo");
  $("nv_block").style.display = nvApplies ? "" : "none";
  if(!nvApplies){
    state.naceVivo = null;
    clearActive(["nv_no","nv_si"]);
  }

  // Retirar aparece cuando:
  // - <14: siempre
  // - >=14: solo tras elegir nace vivo
  var canShowRet = (!nvApplies) || (nvApplies && state.naceVivo!==null);
  $("ret_block").style.display = canShowRet ? "" : "none";
  if(!canShowRet){
    $("ap_block").style.display="none";
    $("go").disabled=true;
    return;
  }

  // retYes/No disponibles seg√∫n escenarios base
  var retBasis = filterScenarios({ group: state.group, naceVivo: state.naceVivo });
  var retYesOk = anyValue(retBasis,"retirada",true);
  var retNoOk  = anyValue(retBasis,"retirada",false);

  // ‚úÖ Regla: desde 14 semanas si nace vivo => retirada obligatoria
  var mustRetYes = (state.group!=="LT14" && state.naceVivo===true);
  if(mustRetYes){
    retYesOk = true;
    retNoOk = false;

    state.retirada = true;
    setActive("ret_si",["ret_no","ret_si"]);

    // ‚úÖ bot√≥n NO visible pero deshabilitado (gris)
    setEnabled("ret_no", false);

    // aviso amarillo
    $("ret_note").style.display="";
    $("ret_note").textContent="‚ö†Ô∏è Si nace vivo, la retirada de los restos por parte de los padres es obligatoria.";
  }

  // habilitar/deshabilitar seg√∫n disponibilidad
  setEnabled("ret_si", retYesOk);
  setEnabled("ret_no", retNoOk);

  // si el estado queda inv√°lido
  if(!retYesOk && state.retirada===true) state.retirada=null;
  if(!retNoOk  && state.retirada===false) state.retirada=null;

  // AP: solo si ya hay retirada seleccionada
  // EXCEPCI√ìN: <14 y retirada=true -> necropsia "no procede", se oculta AP
  if(state.group==="LT14" && state.retirada===true){
    $("ap_block").style.display="none";
    state.necropsia=null;
    clearActive(["ap_no","ap_si"]);
  } else if(state.retirada===null){
    $("ap_block").style.display="none";
    $("go").disabled=true;
    return;
  } else {
    // AP aplica si no todo es null
    var apBasis = filterScenarios({ group: state.group, naceVivo: state.naceVivo, retirada: state.retirada });
    var apApplies = !allNull(apBasis, "necropsia");
    $("ap_block").style.display = apApplies ? "" : "none";

    if(!apApplies){
      state.necropsia=null;
      clearActive(["ap_no","ap_si"]);
      setEnabled("ap_no", false);
      setEnabled("ap_si", false);
    } else {
      var apYesOk = anyValue(apBasis,"necropsia",true);
      var apNoOk  = anyValue(apBasis,"necropsia",false);
      setEnabled("ap_si", apYesOk);
      setEnabled("ap_no", apNoOk);

      if(!apYesOk && state.necropsia===true) state.necropsia=null;
      if(!apNoOk  && state.necropsia===false) state.necropsia=null;

      // regla ‚â•26 + retirada NO: necropsia NO no posible => aviso + desactivar AP=No (visible)
      if(state.group==="GE26" && state.retirada===false){
        $("ap_note").style.display="";
        $("ap_note").textContent="‚ö†Ô∏è Si no desean necropsia, en esta semana de embarazo, los padres deben llevarse los restos.";
        setEnabled("ap_no", false);
        if(state.necropsia===false){
          state.necropsia=null;
          $("ap_no").classList.remove("active");
        }
      }
    }
  }

  // habilitar bot√≥n Mostrar si hay escenario √∫nico
  var candidates = filterScenarios({
    group: state.group,
    naceVivo: state.naceVivo,
    retirada: state.retirada,
    necropsia: state.necropsia
  });

  // si AP visible y no elegido, no habilitar
  if($("ap_block").style.display!=="none" && state.necropsia===null){
    $("go").disabled = true;
    return;
  }
  $("go").disabled = (candidates.length!==1);
}

/* Render salida */
function renderOutput(){
  var candidates = filterScenarios({
    group: state.group,
    naceVivo: state.naceVivo,
    retirada: state.retirada,
    necropsia: state.necropsia
  });
  if(candidates.length!==1){
    $("out").innerHTML =
      '<div class="card"><h2>Error</h2><div style="color:#777">La combinaci√≥n no coincide de forma √∫nica con la tabla.</div></div>';
    return;
  }
  var sc = candidates[0];

  var parts=[];
  parts.push("EG "+state.weeks+" sem");
  parts.push("Intervalo: "+groupLabel(state.group));
  if($("nv_block").style.display!=="none") parts.push("Naci√≥ vivo: "+(state.naceVivo?"S√≠":"No"));
  parts.push("Retiran restos: "+(state.retirada?"S√≠":"No"));
  if($("ap_block").style.display!=="none") parts.push("Necropsia: "+(state.necropsia?"S√≠":"No"));

  var head =
    '<div class="card control-info"><div>'+escapeHtml(parts.join(" ¬∑ "))+
    '</div><div>Escenario: '+escapeHtml(sc.id)+'</div></div>';

  var obsHtml="";
  if(normalizeItem(sc.observaciones)){
    obsHtml =
      '<div class="card obs-card"><div class="obs-title"><span class="obs-icon">‚ÑπÔ∏è</span><h2>Observaciones</h2></div>'+
      '<div style="white-space:pre-wrap">'+escapeHtml(sc.observaciones)+'</div></div>';
  }

  $("out").innerHTML =
    head + obsHtml +
    '<div class="grid2">' +
      renderList("Documentos", sc.documentos) +
      renderList("Env√≠o de muestras", sc.envio) +
    '</div>' +
    renderList("Eliminaci√≥n", sc.eliminacion);

  try{ $("out").scrollIntoView({behavior:"smooth"}); } catch(e){ $("out").scrollIntoView(); }
}

/* ===== Eventos ===== */

// Semanas: 2 d√≠gitos, rango 10‚Äì42
$("weeks").addEventListener("input", function(){
  var digits = String(this.value || "").replace(/\D/g,"");
  if(digits.length>2) digits = digits.slice(0,2);
  if(this.value !== digits) this.value = digits;

  $("out").innerHTML="";

  if(digits.length<2){
    state.weeks=null; state.group=null;
    resetAfterWeeks();
    updateUI();
    $("weeks_hint").style.color="#555";
    $("weeks_hint").textContent="Valores permitidos de 10 a 42.";
    return;
  }

  var w = parseInt(digits,10);
  if(!(w>=10 && w<=42)){
    state.weeks=null; state.group=null;
    resetAfterWeeks();
    updateUI();
    $("weeks_hint").style.color="#a40000";
    $("weeks_hint").textContent="Valor no v√°lido. Debe estar entre 10 y 42.";
    return;
  }

  $("weeks_hint").style.color="#555";
  $("weeks_hint").textContent="Valores permitidos de 10 a 42.";

  state.weeks = w;
  state.group = computeGroup(w);

  resetAfterWeeks();
  updateUI();
});

// Nace vivo
$("nv_no").addEventListener("click", function(){
  if(this.disabled) return;
  resetAfterNV();
  state.naceVivo=false;
  setActive("nv_no",["nv_no","nv_si"]);
  updateUI();
});
$("nv_si").addEventListener("click", function(){
  if(this.disabled) return;
  resetAfterNV();
  state.naceVivo=true;
  setActive("nv_si",["nv_no","nv_si"]);
  updateUI();
});

// Retirada
$("ret_no").addEventListener("click", function(){
  if(this.disabled) return;
  resetAfterRet();
  state.retirada=false;
  setActive("ret_no",["ret_no","ret_si"]);
  updateUI();
});
$("ret_si").addEventListener("click", function(){
  if(this.disabled) return;
  resetAfterRet();
  state.retirada=true;
  setActive("ret_si",["ret_no","ret_si"]);
  updateUI();
});

// AP
$("ap_no").addEventListener("click", function(){
  if(this.disabled) return;
  resetAfterAP();
  state.necropsia=false;
  setActive("ap_no",["ap_no","ap_si"]);
  updateUI();
});
$("ap_si").addEventListener("click", function(){
  if(this.disabled) return;
  resetAfterAP();
  state.necropsia=true;
  setActive("ap_si",["ap_no","ap_si"]);
  updateUI();
});

$("go").addEventListener("click", function(){ renderOutput(); });

// init
updateUI();
</script>
</body>
</html>